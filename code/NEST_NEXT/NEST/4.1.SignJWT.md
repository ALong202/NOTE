# 4.1 Sign JWT

## ğŸ§± BÆ¯á»šC 1: Láº¤Y USER Tá»ª LOCAL STRATEGY

> â€œPassport sáº½ Ä‘áº·t user vÃ o trong request object.â€
> 

Khi báº¡n dÃ¹ng `LocalStrategy` Ä‘á»ƒ Ä‘Äƒng nháº­p:

- PhÆ°Æ¡ng thá»©c `validate()` trong strategy tráº£ vá» user.
- Passport gáº¯n giÃ¡ trá»‹ Ä‘Ã³ vÃ o `req.user`.

â®• Trong `AuthController`, báº¡n cÃ³ thá»ƒ láº¥y láº¡i user tá»« `req.user`.

Äá»ƒ láº¥y `user` dá»… hÆ¡n, NestJS cho phÃ©p báº¡n táº¡o **custom param decorator**.

### ğŸ§© Táº¡o file `current-user.decorator.ts`

```tsx
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const CurrentUser = createParamDecorator(
  (_data, context: ExecutionContext) => {
    const request = context.switchToHttp().getRequest();
    return request.user; // Láº¥y user mÃ  passport gÃ¡n
  },
);

```

â†’ Decorator nÃ y giÃºp báº¡n láº¥y `@CurrentUser()` trong controller mÃ  khÃ´ng cáº§n viáº¿t `req.user` thá»§ cÃ´ng.

---

## ğŸ§± BÆ¯á»šC 2: DÃ™NG `@CurrentUser()` TRONG `AuthController`

Trong `AuthController`:

```tsx
@Post('login')
@UseGuards(LocalAuthGuard)
login(
  @CurrentUser() user: User,
  @Res({ passthrough: true }) response: Response,
) {
  return this.authService.login(user, response);
}

```

### Giáº£i thÃ­ch:

- `@CurrentUser()` â†’ Láº¥y ra user sau khi qua `LocalAuthGuard`.
- `@Res({ passthrough: true })` â†’ Láº¥y Ä‘á»‘i tÆ°á»£ng `response` (Express Response).
    - `passthrough: true` cho phÃ©p NestJS váº«n Ä‘iá»u khiá»ƒn lifecycle (khÃ´ng pháº£i báº¡n gá»­i thá»§ cÃ´ng `res.send`).
- Gá»i `this.authService.login(user, response)` Ä‘á»ƒ táº¡o JWT.

---

## ğŸ§± BÆ¯á»šC 3: CÃ€I Äáº¶T CÃC THÆ¯ VIá»†N JWT

Cáº§n cÃ i:

```bash
npm install @nestjs/jwt passport-jwt
npm install -D @types/passport-jwt

```

---

## ğŸ§± BÆ¯á»šC 4: Cáº¤U HÃŒNH JWT MODULE TRONG `AuthModule`

Táº¡o biáº¿n mÃ´i trÆ°á»ng trong `.env`:

```
JWT_SECRET=someRandomSecureKey
JWT_EXPIRATION=10h

```

ğŸ‘‰ `JWT_SECRET`: khÃ³a bÃ­ máº­t Ä‘á»ƒ kÃ½ & xÃ¡c minh token.

ğŸ‘‰ `JWT_EXPIRATION`: thá»i gian sá»‘ng (VD: `10h`, `2d`, `30m`).

Trong `auth.module.ts`:

```tsx
import { JwtModule } from '@nestjs/jwt';
import { ConfigModule, ConfigService } from '@nestjs/config';

@Module({
  imports: [
    ConfigModule,
    JwtModule.registerAsync({
      imports: [ConfigModule],
      useFactory: async (configService: ConfigService) => ({
        secret: configService.get<string>('JWT_SECRET'),
        signOptions: {
          expiresIn: configService.get<string>('JWT_EXPIRATION'),
        },
      }),
      inject: [ConfigService],
    }),
  ],
  ...
})
export class AuthModule {}

```

### Giáº£i thÃ­ch:

- `JwtModule.registerAsync()` â†’ cho phÃ©p cáº¥u hÃ¬nh async, láº¥y tá»« `ConfigService`.
- `secret`: dÃ¹ng Ä‘á»ƒ kÃ½ & xÃ¡c minh token.
- `expiresIn`: thá»i háº¡n token.

---

## ğŸ§± BÆ¯á»šC 5: VIáº¾T HÃ€M `login()` TRONG `AuthService`

### Má»¥c tiÃªu:

- Táº¡o JWT tá»« user ID.
- LÆ°u JWT vÃ o cookie (khÃ´ng tráº£ vá» JSON trá»±c tiáº¿p).

VÃ¬ sao dÃ¹ng cookie?

> Giáº£ng viÃªn nÃ³i:
> 
> 
> "Cookie cÃ³ thá»ƒ set cÃ¡c thuá»™c tÃ­nh báº£o máº­t nhÆ° `httpOnly` vÃ  `secure`, giÃºp token khÃ´ng bá»‹ truy cáº­p tá»« JS hoáº·c gá»­i qua HTTP khÃ´ng mÃ£ hÃ³a."
> 

### MÃ£ code:

```tsx
async login(user: User, response: Response) {
  const expires = new Date();
  expires.setMilliseconds(
    expires.getMilliseconds() +
      ms(this.configService.get<string>('JWT_EXPIRATION')),
  );

  const tokenPayload: TokenPayload = { userId: user.id };
  const token = this.jwtService.sign(tokenPayload);

  response.cookie('Authentication', token, {
    httpOnly: true,  // KhÃ´ng thá»ƒ truy cáº­p báº±ng JS
    secure: true,    // Chá»‰ gá»­i qua HTTPS (trá»« localhost)
    expires,         // Háº¿t háº¡n cÃ¹ng JWT
  });

  return { tokenPayload };
}

```

ğŸ‘‰ `ms()` lÃ  thÆ° viá»‡n giÃºp chuyá»ƒn â€œ10hâ€ â†’ mili-giÃ¢y.

CÃ i:

```bash
npm install ms
npm install -D @types/ms

```

vÃ  báº­t trong `tsconfig.json`:

```json
"esModuleInterop": true

```

---

## ğŸ§± BÆ¯á»šC 6: TEST Káº¾T QUáº¢

Sau khi login:

- Server tráº£ HTTP `201 Created`.
- Header `Set-Cookie` chá»©a:
    
    ```
    Authentication=<JWT_TOKEN>; HttpOnly; Secure; Expires=<10h_from_now>
    
    ```
    

TrÃ¬nh duyá»‡t (hoáº·c Postman â†’ tab Cookies) sáº½ tháº¥y cookie `Authentication` Ä‘Æ°á»£c set.

ğŸ‘‰ LÃºc nÃ y token **Ä‘Æ°á»£c lÆ°u trong cookie**, khÃ´ng náº±m trong `localStorage`.

ğŸ‘‰ CÃ¡c request sau cá»§a frontend sáº½ **tá»± gá»­i cookie** kÃ¨m request, giÃºp backend xÃ¡c minh.

---

## ğŸ§± TÃ“M Táº®T DÃ’NG CHáº¢Y LOGIN

1. User gá»­i `/login` vá»›i email + password.
2. `LocalAuthGuard` dÃ¹ng `LocalStrategy` â†’ xÃ¡c thá»±c & gÃ¡n `req.user`.
3. `@CurrentUser()` láº¥y `req.user` trong controller.
4. `AuthService.login()` táº¡o JWT vá»›i `JwtService.sign()`.
5. JWT Ä‘Æ°á»£c **set vÃ o cookie HTTP-only + Secure**.
6. Frontend chá»‰ cáº§n gá»­i request â€” cookie tá»± Ä‘á»™ng kÃ¨m theo â†’ backend xÃ¡c thá»±c token.

---

## ğŸ§  Káº¾T QUáº¢ Há»ŒC ÄÆ¯á»¢C

| Má»¥c | Giáº£i thÃ­ch |
| --- | --- |
| **JWT** | LÃ  token chá»©a thÃ´ng tin ngÆ°á»i dÃ¹ng (vd: id) dÃ¹ng Ä‘á»ƒ xÃ¡c thá»±c cÃ¡c request sau |
| **Local Strategy** | XÃ¡c thá»±c email/password, gáº¯n `req.user` |
| **Custom Decorator** | Táº¡o `@CurrentUser()` Ä‘á»ƒ láº¥y `req.user` tiá»‡n hÆ¡n |
| **Response cookie** | LÆ°u token vÃ o cookie (an toÃ n hÆ¡n localStorage) |
| **HTTP-only Cookie** | JS khÃ´ng Ä‘á»c Ä‘Æ°á»£c â†’ trÃ¡nh XSS |
| **Secure Cookie** | Chá»‰ gá»­i qua HTTPS |
| **JwtModule.registerAsync** | Láº¥y secret vÃ  expiration tá»« `.env` |
| **ConfigService** | Truy xuáº¥t biáº¿n mÃ´i trÆ°á»ng an toÃ n |